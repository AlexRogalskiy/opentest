const fs = require('fs');
const path = require('path');
const shelljs = require('shelljs');

console.log('Verifying npm cache');
shelljs.exec('npm cache verify');

console.log('\nInstalling server dependency modules. This might take a couple of minutes.');
var isWindows = process.platform.toLocaleLowerCase().indexOf("win") === 0;
let npmInstallCommand;
if (isWindows) {
    // We are using --no-optional to try avoiding the fsevents on Windows
    // issue (https://github.com/npm/npm/issues/17671)
    npmInstallCommand = 'npm install --production --no-optional';
} else {
    npmInstallCommand = 'npm install --production --no-optional';
}
console.log(`Running "${npmInstallCommand}"...`);

const serverDir = path.join(__dirname, 'opentest-server');

shelljs.cd(serverDir);
const renamedLockFile = path.join(serverDir, 'package-lock-renamed.json');
if (fs.existsSync(renamedLockFile)) {
    shelljs.mv(renamedLockFile, path.join(serverDir, 'package-lock.json'));
}
shelljs.exec(npmInstallCommand);

console.log('Done installing dependencies');