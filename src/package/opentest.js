#!/usr/bin/env node
const spawn = require('child_process').spawn;
const fs = require('fs');
const path = require('path');
const inquirer = require('inquirer');
const shelljs = require('shelljs');
const vm = require('vm');
const yargs = require('yargs');

const currentDir = process.cwd();

yargs
    // server
    .command('server', 'OpenTest server commands', function (yargs) {
        // server init
        yargs.command(
            'init',
            'Initializes the OpenTest server working directory',
            function (argv) { initServer(argv) });
        // server start
        yargs.command(
            'start [workdir]',
            'Starts OpenTest server in the current directory, or in the directory specified',
            function (yargs) {
                yargs.positional('workdir', {
                    describe: 'The working directory to start the server in',
                    type: 'string'
                });
            },
            function (argv) { startServer(argv) });

        yargs.demandCommand();
    })
    // actor
    .command('actor', 'Test actor commands', function (yargs) {
        // actor init
        yargs.command(
            'init',
            'Initializes the test actor\'s working directory',
            function (argv) { initActor(argv) });
        // actor start
        yargs.command(
            'start [workdir]',
            'Starts a test actor in the current directory, or in the directory specified',
            function (yargs) {
                yargs.positional('workdir', {
                    describe: 'The working directory to start the server in',
                    type: 'string'
                });
            },
            function (argv) { startActor(argv) });

        yargs.demandCommand();
    })
    .help()
    .alias('h', 'help')
    .version()
    .alias('v', 'version')
    .demandCommand()
    .argv;

function createServerWorkDir(workDir, testRepoDir) {
    shelljs.mkdir('-p', workDir);
    const sampleConfigFile = path.join(__dirname, "opentest-server", "server.yaml");
    const serverConfigFile = path.join(workDir, 'server.yaml');

    if (!fs.existsSync(testRepoDir)) {
        createTestRepoDir();
    }

    const configFileContent = shelljs.sed(/testRepoDir:.*/, 'testRepoDir: ' + JSON.stringify(testRepoDir), sampleConfigFile);
    fs.writeFileSync(serverConfigFile, configFileContent);
}

function createTestRepoDir(testRepoDir) {
    // Create and initialize test repo
    shelljs.mkdir('-p', testRepoDir);
}

/** Returns the name of the test actor root directory, without the path. The
 * algorithm is pretty rudimentary - it just returns the first directory in
 * the module's path whose name starts with "opentest-actor". */
function findActorDirName() {
    const files = fs.readdirSync(__dirname);
    for (let file of files) {
        const fileFullPath = path.join(__dirname, file);
        if (file.indexOf('opentest-actor') === 0 && fs.statSync(fileFullPath).isDirectory()) {
            return file;
        }
    }
}

function initActor(argv) {
    const workDir = yargs.argv.workdir || process.cwd();
}

function initServer(argv) {
    let workDir = path.join(process.cwd(), 'server');
    let testRepoDir = null;

    const questions = [{
        type: 'input',
        name: 'workDir',
        message: "Server's working directory",
        default: workDir,
        when: () => {
            console.log(
                '\nPlease provide the OpenTest server\'s working directory. This is where the\n' +
                'server\'s configuration file, database files and logs will be stored.');
            return true;
        },
        validate: (workDir) => {
            testRepoDir = path.join(
                path.normalize(path.join(workDir, '..')),
                'test-repo');
            return true;
        }
    }, {
        type: 'input',
        name: 'testRepoDir',
        message: "Test repo directory",
        default: () => { return testRepoDir; },
        when: () => {
            console.log(
                '\nThe OpenTest server will need to know where to find the test repository. If you\n' +
                'don\'t have one yet, it will be created and initialized for you. Please provide\n' +
                'the full path to your test repo directory below.');
            return true;
        }
    }];

    inquirer.prompt(questions).then(answers => {
        let workDir = makeAbsolute(answers.workDir);
        let testRepoDir = makeAbsolute(answers.testRepoDir);
        createServerWorkDir(workDir, testRepoDir);
        createTestRepoDir(testRepoDir);

        const workDirName = path.basename(workDir);
        let startCommand;
        if (workDir == path.join(process.cwd(), workDirName)) {
            startCommand = 'opentest server start ' + workDirName;
        } else {
            startCommand = 'opentest server start ' + workDir;
        }

        shelljs.cd(workDir);
        console.log('\nWell done! You are now ready to run your first test.');
        console.log(`Run the commands bellow to start the OpenTest server:\n`);

        console.log('cd ' + workDir);
        console.log('opentest server start');
    });
}

function makeAbsolute(filePath) {
    filePath = path.normalize(filePath);

    if (path.isAbsolute(filePath)) {
        return filePath;
    } else {
        return path.join(process.cwd(), filePath);
    }
}

function startActor(argv) {
    const workDir = argv.workdir || process.cwd();
    const actorDir = path.join(__dirname, findActorDirName());
    const classPath = path.join(actorDir, '*').replace(/\\/g, '/')

    const newProcess = spawn(
        'java',
        ['-cp', classPath, 'org.getopentest.Main', '--workdir', workDir],
        { stdio: 'inherit' });

    newProcess.on('error', function (err) {
        console.log('ERROR: ' + err.message);
        if (err.code === 'ENOENT') {
            console.log('ERROR: Failed to start Java process. Please ensure that the Java runtime is properly installed.');
        }
    });
}

function startServer(argv) {
    const workDir = argv.workdir || process.cwd();
    const syncServerDir = path.join(__dirname, 'opentest-server');

    const newProcess = spawn(
        'node',
        [path.join(syncServerDir, 'build', 'service.js'), '-- --workdir', workDir],
        { stdio: 'inherit' });

    newProcess.on('error', function (err) {
        console.log('ERROR: ' + err.message);
        if (err.code === 'ENOENT') {
            console.log('ERROR: Failed to start Node.js process. Please ensure that Node.js is properly installed.');
        }
    });
}