package org.getopentest;

import java.io.File;
import java.util.Arrays;
import joptsimple.OptionParser;
import joptsimple.OptionSet;
import org.getopentest.base.TestActor;
import org.getopentest.contracts.ITestActor;
import org.getopentest.logging.Logger;

public class Main {

    public static void main(String[] args) {
        processCommandLineArgs(args);
        ITestActor actor = new TestActor();

        while (true) {
            try {
                actor.runOneSession();
            } catch (Exception ex) {
                Logger.error("An exception was thrown from the runOneSession method, which shouldn't "
                        + "normally happen and might indicate a bug. Please provide all potentially "
                        + "relevant data to the dev team for a fix (logs, context, etc).", ex);
            }
        }
    }

    private static void processCommandLineArgs(String[] args) {
        OptionParser parser = new OptionParser();

        String[] workdirOptions = {"w", "workdir"};
        parser.acceptsAll(Arrays.asList(workdirOptions)).withRequiredArg();

        OptionSet options = parser.parse(args);

        // workdir
        Object workDirObj = options.valueOf("workdir");
        if (workDirObj != null) {
            String workDirPath = options.valueOf("workdir").toString();
            File file = new File(workDirPath);

            if (file.exists() && file.isDirectory()) {
                System.setProperty("user.dir", file.getAbsolutePath());
            }
        }
    }
}
