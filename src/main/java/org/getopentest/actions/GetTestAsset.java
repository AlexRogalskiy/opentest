package org.getopentest.actions;

import org.getopentest.base.TestAction;
import java.io.File;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;

/**
 * Read the contents of an object from an AWS S3 bucket into a file on disk.
 */
public class GetTestAsset extends TestAction {

    @Override
    public void run() {
        super.run();

        String assetType = this.readStringArgument("assetType");
        String assetRelativePath = this.readStringArgument("assetRelativePath");
        String targetFilePath = this.readStringArgument("targetFile");
        Boolean overwrite = this.readBooleanArgument("overwrite", false);

        File targetFile = new File(targetFilePath);
        targetFile.getParentFile().mkdirs();

        try {
            InputStream assetStream = this.getActor().getTestAsset(assetType, assetRelativePath);

            if (overwrite) {
                Files.copy(assetStream, Paths.get(targetFilePath), StandardCopyOption.REPLACE_EXISTING);
            } else {
                Files.copy(assetStream, Paths.get(targetFilePath));
            }
        } catch (Exception ex) {
            throw new RuntimeException(String.format(
                    "Failed to transfer data from the test asset input stream into file %s",
                    targetFilePath), ex);
        }
    }
}
