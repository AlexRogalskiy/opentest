extends layout
block content
    script.
        var sessionId = '#{session.id}';

    script.
        var debounce = function(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)func.apply(context,args);};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)func.apply(context,args);};};
        var saveAs = saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",d=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(a){u(a)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,d){if(!d){t=p(t)}var v=this,w=t.type,m=w===s,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;a(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define("FileSaver.js",function(){return saveAs})}
        function format(text){var args=arguments;return text.replace(/\{(\d+)\}/g,function(match,index){var argIndex=Number(index)+1;return typeof args[argIndex]!=='undefined'?args[argIndex]:match;});}

    div.container(ng-controller="SessionCtrl" ng-cloak)
        div.row
            div.col-sm-12
                h4
                    | Test session {{vm.session.id}}&nbsp;&nbsp;
                    span.badge {{vm.session.status}}
        div.row
            div.col-md-12
                div.row
                    div.col-md-6
                        ul.nav.nav-tabs(data-tabs="tabs")
                            li.active
                                a(href="#results" data-toggle="tab") Test results
                            li
                                a(href="#log" data-toggle="tab") Log
                            li
                                a(href="#options" data-toggle="tab") Options
                    div.col-md-6
                        div.dropdown.pull-right(ng-show="vm.getActiveTab() === 'log'")
                            button.btn.btn-small.btn-default.dropdown-toggle(data-toggle="dropdown")
                                | Go to test &nbsp;<span class="caret"></span>
                            ul.dropdown-menu.dropdown-menu-right
                                li
                                    a(ng-repeat="test in vm.session.tests" ng-click="vm.goToTest(test)" href="#") {{test.name}}
                        
                          
                p
                div.tab-content
                    //- TEST RESULTS TAB
                    div.tab-pane.active(id="results")
                            div.row(ng-cloak)
                                div.col-md-8
                                    table.table.table-hover(style="table-layout: fixed")
                                            thead
                                                tr
                                                    th Test
                                                    th(style="width: 65px") Duration
                                                    th(style="width: 55px") Result
                                            tbody
                                                tr(ng-repeat="test in vm.session.tests")
                                                    td
                                                        span.test-name(style="word-wrap: break-word; overflow-wrap: break-word;") {{test.name}}&#32
                                                        span.faded {{test.path}}
                                                    td {{test.timeCompleted ? vm.Math.round((test.timeCompleted - test.timeStarted)/1000) + ' sec' : 'N/A'}}
                                                    td
                                                        span.label.label-default(ng-show="!test.result || test.result === 'pending'") pending
                                                        span.label.label-success(ng-show="test.result === 'passed'") passed
                                                        span.label.label-danger(ng-show="test.result === 'failed'") failed
                                div.col-md-4
                                    div.panel.panel-default
                                        div.panel-heading SUMMARY
                                        table.table.table-hover
                                            tr
                                                td Created
                                                td {{vm.session.timeCreated ? vm.moment(vm.session.timeCreated).format('LLL') : 'N/A'}}
                                            tr
                                                td Started
                                                td {{vm.session.timeStarted ? vm.moment(vm.session.timeStarted).format('LLL') : 'N/A'}}
                                            tr
                                                td Completed
                                                td {{vm.session.timeCompleted ? vm.moment(vm.session.timeCompleted).format('LLL') : 'N/A'}}
                                            tr
                                                td Status
                                                td {{vm.session.status}}
                                            tr
                                                td Result
                                                td {{vm.session.result}}
                    
                    //- LOG TAB
                    div.tab-pane(id="log")
                        table.table.table-condensed
                                thead
                                    tr
                                        th Timestamp
                                        th Actor
                                        th Message
                                tbody
                                    each logEntry in logEntries
                                        tr
                                            td(style="border: none")= moment(logEntry.time).format('HH:mm:ss')
                                            td(style="border: none")= logEntry.actorType
                                            - if (logEntry.msg.indexOf('ERROR') === 0)
                                                td(style="border: none")
                                                    pre(style="white-space: pre-wrap;")= logEntry.msg
                                            - else
                                                td(style="border: none")= logEntry.msg
                        script.
                            // Add link for scrolling to the top of the page
                            $('#log').prepend('<a href="#" class="back-to-top" title="Go to top"><span class="caret-up"></span></a>');
                            
                            var amountScrolled = 500;
                            var scrollHandlerDebounced = debounce(function() {
                                if ( $(window).scrollTop() > amountScrolled ) {
                                    $('a.back-to-top').fadeIn();
                                } else {
                                    $('a.back-to-top').fadeOut();
                                }
                            }, 200);

                            $(window).scroll(scrollHandlerDebounced);
                    
                    //- OPTIONS TAB
                    div.tab-pane(id="options")
                        button.btn.btn-small.btn-default.btn-space(ng-click="vm.cancelSession(vm.session.id)" ng-disabled="vm.session.status === 'completed'") Cancel Session
                        div.btn-group
                            button.btn.btn-default.dropdown-toggle.btn-space(data-toggle="dropdown")
                                |Save results &nbsp;<span class="caret"></span>
                            ul.dropdown-menu
                                li
                                    a(ng-click="vm.saveTestResultsAsCsv()" href="#") Save test results as CSV
    script.
        // Javascript to enable link to tab
        var url = document.location.toString();
        if (url.match('#')) {
            $('.nav-tabs a[href="#' + url.split('#')[1] + '"]').tab('show');
        } 

        // Change hash in address bar on page-reload or tab select
        $('.nav-tabs a').on('shown.bs.tab', function (e) {
            if (history.pushState) {
                history.pushState(null, null, e.target.hash);
            } else {
                window.location.hash = e.target.hash;
            }
        });
                
block append body_footer
    script(src="/js/ng/SessionCtrl.js")