var appRoot = require('app-root-path').path;
var bunyan = require('bunyan');
var mkdirp = require('mkdirp');
var path = require('path'); 
var _ = require('underscore');

var appLog = bunyan.createLogger({ name: 'app' });
var sessionLogs = {};

function getApplog(sessionId) {
    return appLog;
}

function getSessionLog(sessionId) {
    // Ensure the "logs" directory exists
    mkdirp(path.join(appRoot, 'logs'));

    var log;

    if (!sessionLogs[sessionId]) {
        log = bunyan.createLogger({
            name: sessionId,
            streams: [{
                level: 'debug',
                path: path.join(appRoot, 'logs', sessionId + '.log')
            }]
        });
        sessionLogs[sessionId] = log;
    } else {
        log = sessionLogs[sessionId];
    }

    // Provide a method for clients to flush the write
    // stream to ensure all data was persisted 
    log.flushStreams = _.debounce(
        log.reopenFileStreams.bind(log),
        5000,
        true
    );

    return log;
}

module.exports = {
    getApplog: getApplog,
    getSessionLog: getSessionLog
};