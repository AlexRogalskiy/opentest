const config = require('../lib/config-loader.js').config;
const fs = require('fs');
const helpers = require('../lib/helpers.js');
const path = require('path');
const rootDir = require('../lib/root-dir.js');
const shelljs = require('shelljs');

helpers.logTitle('Copying final deliverables to module directory...');

const opentestModuleDir = path.join(rootDir, 'dist', 'module-opentest');

prepareOpentestModuleFiles();
prepareActorFiles();
prepareServerFiles();

function prepareActorFiles() {
    const actorProjectDir = config.actor && config.actor.projectDir ?
        path.join(rootDir, config.actor.projectDir.replace(/[\/\\]/g, path.sep)) :
        path.join(rootDir, 'actor', 'actor');
    const actorDestinationDir = path.join(opentestModuleDir, 'actor');

    console.log('Cleaning-up actor dir...');
    shelljs.rm('-rf', actorDestinationDir);
    shelljs.mkdir('-p', actorDestinationDir);

    console.log('Copying actor files to module dir...');

    shelljs.cp(
        '-r',
        path.join(actorProjectDir, 'target', 'dependency-jars'),
        path.join(actorDestinationDir, 'jars'));
    shelljs.cp(
        path.join(actorProjectDir, 'target', 'classes', 'actor.sample.yaml'),
        path.join(actorDestinationDir, 'actor.yaml'));
    shelljs.cp(
        path.join(actorProjectDir, 'target', 'classes', 'run.bat'),
        actorDestinationDir);
}

function prepareOpentestModuleFiles() {
    const opentestModuleSourceDir = path.join(rootDir, 'build', 'module-opentest');

    console.log('Cleaning-up opentest module dir...');
    shelljs.rm('-rf', opentestModuleDir);
    shelljs.mkdir('-p', opentestModuleDir);

    console.log('Copying opentest module files to module dir...');
    shelljs.cp(
        '-r',
        path.join(opentestModuleSourceDir, 'sample-repo'),
        opentestModuleDir);
    shelljs.cp(
        path.join(opentestModuleSourceDir, 'package.json'),
        opentestModuleDir);
    shelljs.cp(
        path.join(opentestModuleSourceDir, 'package-lock.json'),
        opentestModuleDir);
    shelljs.cp(
        path.join(opentestModuleSourceDir, 'opentest.js'),
        opentestModuleDir);
    shelljs.cp(
        path.join(opentestModuleSourceDir, 'README.md'),
        opentestModuleDir);
}

function prepareServerFiles() {
    const serverProjectDir = path.join(rootDir, 'server');
    const serverDestinationDir = path.join(opentestModuleDir, 'server');

    console.log('Cleaning-up server module dir...');
    shelljs.rm('-rf', serverDestinationDir);
    shelljs.mkdir('-p', serverDestinationDir);

    console.log('Copying server files to module dir...');
    shelljs.cp(
        '-r',
        path.join(serverProjectDir, 'bin'),
        serverDestinationDir);
    shelljs.cp(
        '-r',
        path.join(serverProjectDir, 'dist'),
        serverDestinationDir);
    shelljs.cp(
        path.join(serverProjectDir, 'package.json'),
        serverDestinationDir);
    shelljs.cp(
        path.join(serverProjectDir, 'package-lock.json'),
        serverDestinationDir);
    shelljs.cp(
        path.join(serverProjectDir, 'build-info.json'),
        serverDestinationDir);
    shelljs.cp(
        path.join(serverProjectDir, 'index.js'),
        serverDestinationDir);
    shelljs.cp(
        path.join(serverProjectDir, 'README.md'),
        serverDestinationDir);
    shelljs.cp(
        path.join(serverProjectDir, 'server.sample.yaml'),
        path.join(serverDestinationDir, 'server.yaml'));

    // Remove "devDependencies" and "scripts" sections from package.json
    let packageJson = fs.readFileSync(path.join(serverProjectDir, 'package.json')).toString('utf8');
    packageJson = packageJson.replace(/,[\s\t\r\n]*"devDependencies":[\s\S]*?},?[\s\S]*?[\r\n]*/m, '');
    packageJson = packageJson.replace(/^\s*"scripts":[\s\S]*?},?[\s\S]*?[\r\n]*/m, '');
    fs.writeFileSync(path.join(serverDestinationDir, 'package.json'), packageJson);
}